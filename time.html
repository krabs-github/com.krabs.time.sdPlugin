<!DOCTYPE html>
<html>
    <head>
        <title>com.krabs.time.action</title>
        <meta charset="utf-8" />
    </head>
    <body>
        <script>
            let websocket = null;
            let pluginUUID = null;
            let actionInfo = {};
            let DestinationEnum = Object.freeze({ HARDWARE_AND_SOFTWARE: 0, HARDWARE_ONLY: 1, SOFTWARE_ONLY: 2 });
            var settingsCache = {};
            var base64Img = null;
// Beginning of let KrabsTime definition
            let KrabsTime = {
                type: "com.krabs.time.action",
                onKeyDown: function (context, settings, coordinates, userDesiredState) {
                    /* Code here will run when the key is pressed https://developer.elgato.com/documentation/stream-deck/sdk/events-received/#keydown */
                },
                onKeyUp: function (context, settings, coordinates, userDesiredState) {
                    /* Code here will run when the key is released https://developer.elgato.com/documentation/stream-deck/sdk/events-received/#keyup */
                    settingsCache[context] = settings;
                },
                fKrabs_Time: function (context, settings) {
                    var payload = settingsCache[context];
                    var vShowTime = payload['vKrabs_ShowTime'];
                    var vShowDate = payload['vKrabs_ShowDate'];
                    var vShowDay = payload['vKrabs_ShowDayName'];
                    var vBackgroundType = payload['vKrabs_BackgroundType'];
                    var vCustomBackgroundColor = payload['vKrabs_CustomBackgroundColor'];
                    /*if (payload != null && payload.hasOwnProperty('vKrabs_EventDate')) {
                      var vEventDate = payload['vKrabs_EventDate'];
                    }*/

                    function getData() {
                      var payload = settingsCache[context];
                      var vShowTime = payload['vKrabs_ShowTime'];
                      var vShowDate = payload['vKrabs_ShowDate'];
                      var vShowDay = payload['vKrabs_ShowDayName'];
                      var vBackgroundType = payload['vKrabs_BackgroundType'];
                      var vCustomBackgroundColor = payload['vKrabs_CustomBackgroundColor'];

                      var vDate_Now = new Date();
                      var vTime = vDate_Now.toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true })
                      var vHour24 = vDate_Now.getHours()
                      var vDate = vDate_Now.toLocaleString('en-US', { month: 'short', day: 'numeric' })
                      var vDayName = vDate_Now.toLocaleString('en-US', { weekday: 'long' })
                      var [vTime_Numbers, vTime_AMPM] = vTime.split(' ');
                      var vTime_AMPM = vTime_AMPM.toLowerCase()
                      /*console.log(vTime_Numbers + vTime_AMPM);
                      console.log(vHour24);
                      console.log(vDate);
                      console.log(vDayName);*/

                      KrabsTime.SetTitle(context, "");

                      var imageUrl = "resources/images/Adaptive/" + vHour24 + ".png";
                      convertImgToBase64_text(imageUrl, vShowTime, vShowDate, vShowDay, vBackgroundType, vTime_Numbers, vTime_AMPM, vDate, vDayName, function(base64Img){
                      var vAvatarBase64 = base64Img;
                      setImage(context, vAvatarBase64);
                      });
                    }
                  getData();
                  setTimeout(function run() {
                    getData();
                    var vShowTime = payload['vKrabs_ShowTime'];
                    var vShowDate = payload['vKrabs_ShowDate'];
                    var vShowDay = payload['vKrabs_ShowDayName'];
                    var vBackgroundType = payload['vKrabs_BackgroundType'];
                    var vCustomBackgroundColor = payload['vKrabs_CustomBackgroundColor'];
                    setTimeout(run, 1000);
                  }, 1000);
                },
                // End of fKrabs_Time function

                onWillAppear: function (context, settings, coordinates) {
                    /* Code here will run when the Stream Deck application is opened, the user switches between profiles or when a user adds the action
                        to their Stream Deck https://developer.elgato.com/documentation/stream-deck/sdk/events-received/#willappear
                    */
                    console.log("onWillAppear context: ", context, " settings: ", settings);
                    settingsCache[context] = settings;
                    var payload = settingsCache[context];
                    KrabsTime.fKrabs_Time(context, settings);
                },
                onWillDisappear: function (context, settings, coordinates) {
                    console.log("onWillDisappear context: ", context, " settings: ", settings);
                },
                SetTitle: function (context, vAnswer) {
                    let json = { event: "setTitle", context: context, payload: { title: ""+ vAnswer, target: DestinationEnum.HARDWARE_AND_SOFTWARE } };
                    websocket.send(JSON.stringify(json));
                },
                getSettings: function (context, payload) {
                    websocket.send(context, 'getSettings', {});
                    console.log(settings)
                },
                SetSettings: function (context, settings) {
                    var json = {
                        "event": "setSettings",
                        "context": context,
                        "payload": settings
                    };

                    websocket.send(JSON.stringify(json));
                    settingsCache[context] = settings;
                    console.log("New Settings", settings);
                    console.log("New JSON", JSON.stringify(json));
                },
                didReceiveSettings: function (context, payload) {
                  console.log("Did receive: ", settings)
                }
            };
// End of let KrabsTime definition
            function canvasShake(context) {
              function fShake(context, vPosX, vPosY, vRotate) {
                var imageUrl = "resources/images/actionDefaultImage.png";
                convertImgToBase64_motion(imageUrl, vPosX, vPosY, vRotate, function(base64Img){
                var vAvatarBase64 = base64Img;
                setImage(context, vAvatarBase64);
                });
              };
              setTimeout(function() { fShake(context,3,1,0) }, 100);
              setTimeout(function() { fShake(context,0,0,0) }, 200);
              setTimeout(function() { fShake(context,-5,-2,0) }, 300);
              setTimeout(function() { fShake(context,6,1,0) }, 400);
              setTimeout(function() { fShake(context,-3,0,0) }, 500);
              setTimeout(function() { fShake(context,1,2,0) }, 600);
              setTimeout(function() { fShake(context,0,-1,0) }, 700);
              setTimeout(function() { fShake(context,-2,0,0) }, 800);
              setTimeout(function() { fShake(context,4,2,0) }, 900);
              setTimeout(function() { fShake(context,0,0,0) }, 1000);
            };

            function convertImgToBase64_text(url, vShowTime, vShowDate, vShowDay, vBackgroundType, vTime_Numbers, vTime_AMPM, vDate, vDayName, callback, outputFormat){
              var canvas = document.createElement('CANVAS');
              var ctx = canvas.getContext('2d');
              var img = new Image;
              img.crossOrigin = 'Anonymous';
              img.onload = function(){
                  canvas.height = img.height;
                  canvas.width = img.width;
                    ctx.drawImage(img,0,0);
                    // Text, width, height
                    if (vShowTime == true && vShowDate == true) {
                      // Time
                      ctx.shadowOffsetX = 4;
                      ctx.shadowOffsetY = 4;
                      ctx.shadowColor = "rgba(0,0,0,0.2)";
                      ctx.shadowBlur = 4;
                      ctx.font = "28px Impact";
                      ctx.fillStyle = 'white';
                      ctx.textAlign = 'center';
                      ctx.fillText(vTime_Numbers, 36, 36);
                      // AM or PM
                      /*ctx.font = "10px Impact";
                      ctx.fillStyle = 'white';
                      ctx.textAlign = 'start';
                      ctx.fillText(vTime_AMPM, 58, 36);*/
                      // Date
                      ctx.font = "16px Impact";
                      ctx.fillStyle = 'white';
                      ctx.textAlign = 'center';
                      ctx.fillText(vDate, 36, 52);
                      // Day Name
                        if (vShowDay == true) {
                          ctx.shadowOffsetX = 4;
                          ctx.shadowOffsetY = 4;
                          ctx.shadowColor = "rgba(0,0,0,0.2)";
                          ctx.shadowBlur = 4;
                          ctx.font = "bold 12px Arial";
                          ctx.fillStyle = 'white';
                          ctx.textAlign = 'center';
                          ctx.fillText(vDayName, 36, 68);
                        }

                    } else if (vShowTime == true && vShowDate == false) {

                    } else if (vShowTime == false && vShowDate == true) {

                    } else {
                      // Time
                      ctx.shadowOffsetX = 4;
                      ctx.shadowOffsetY = 4;
                      ctx.shadowColor = "rgba(0,0,0,0.2)";
                      ctx.shadowBlur = 4;
                      ctx.font = "28px Impact";
                      ctx.fillStyle = 'white';
                      ctx.textAlign = 'center';
                      ctx.fillText(vTime_Numbers, 36, 36);
                      // Date
                      ctx.font = "16px Impact";
                      ctx.fillStyle = 'white';
                      ctx.textAlign = 'center';
                      ctx.fillText(vDate, 36, 52);
                      // Day Name
                          ctx.shadowOffsetX = 4;
                          ctx.shadowOffsetY = 4;
                          ctx.shadowColor = "rgba(0,0,0,0.2)";
                          ctx.shadowBlur = 4;
                          ctx.font = "bold 12px Arial";
                          ctx.fillStyle = 'white';
                          ctx.textAlign = 'center';
                          ctx.fillText(vDayName, 36, 68);
                    }

                    // shape
                    //ctx.fillStyle = 'rgba(0, 0, 200, 0.5)';
                    //ctx.fillRect(30, 30, 20, 20);
                    var dataURL = canvas.toDataURL(outputFormat || 'image/png');
                    callback.call(this, dataURL);
                  // Clean up
                    canvas = null;
              };
              img.src = url;
            };

            function convertImgToBase64_motion(url, vPosX, vPosY, vRotate, callback, outputFormat){
              var canvas = document.createElement('CANVAS');
              var ctx = canvas.getContext('2d');
              var img = new Image;
              img.crossOrigin = 'Anonymous';
              img.onload = function(){
                  canvas.height = img.height;
                  canvas.width = img.width;
                    //ctx.rotate(vRotate*Math.PI/180);
                    ctx.drawImage(img,vPosX,vPosY);
                    var dataURL = canvas.toDataURL(outputFormat || 'image/png');
                    callback.call(this, dataURL);
                  // Clean up
                    canvas = null;
              };
              img.src = url;
            };

            function convertImgToBase64(url, callback, outputFormat){
              var canvas = document.createElement('CANVAS');
              var ctx = canvas.getContext('2d');
              var img = new Image;
              img.crossOrigin = 'Anonymous';
              img.onload = function(){
                  canvas.height = img.height;
                  canvas.width = img.width;
                    ctx.drawImage(img,0,0);
                    var dataURL = canvas.toDataURL(outputFormat || 'image/png');
                    callback.call(this, dataURL);
                  // Clean up
                    canvas = null;
              };
              img.src = url;
            };
            function logMessage(context, vLogMessage) {
                if (websocket) {
                    var json = {
                        'event': 'logMessage',
                        'context': context,
                        'payload': {
                            'message': vLogMessage
                        }
                    };
                    websocket.send(JSON.stringify(json));
                }
            }
            // Set the state of a key
            function setState(context, inState) {
                if (websocket) {
                    var json = {
                        'event': 'setState',
                        'context': context,
                        'payload': {
                            'state': inState
                        }
                    };
                    websocket.send(JSON.stringify(json));
                }
            }
            function setImage (context, vAvatarBase64) {
              var json = {
                  'event': 'setImage',
                  'context': context,
                  'payload': {
                      'image': vAvatarBase64,
                      'target': DestinationEnum.HARDWARE_AND_SOFTWARE
                  }
                };
              websocket.send(JSON.stringify(json));
            }

            function connectElgatoStreamDeckSocket(inPort, inPluginUUID, inRegisterEvent, inInfo, inActionInfo) {
                pluginUUID = inPluginUUID;
                websocket = new WebSocket("ws://127.0.0.1:" + inPort);
                function registerPlugin(inPluginUUID) {
                    let json = { event: inRegisterEvent, uuid: inPluginUUID };
                    websocket.send(JSON.stringify(json));
                }
                websocket.onopen = function () {
                    registerPlugin(pluginUUID);
                };
                websocket.onmessage = function (evt) {
                    let jsonObj = JSON.parse(evt.data);
                    console.log("onmessage json: ", jsonObj);
                    let event = jsonObj["event"];
                    let action = jsonObj["action"];
                    let context = jsonObj["context"];
                    let actionInfo = jsonObj["inActionInfo"];
                    var jsonPayload = jsonObj['payload'] || {};
                    if (event == "keyDown") {
                        let jsonPayload = jsonObj["payload"];
                        let settings = jsonPayload["settings"];
                        let coordinates = jsonPayload["coordinates"];
                        let userDesiredState = jsonPayload["userDesiredState"];
                        KrabsTime.onKeyDown(context, settings, coordinates, userDesiredState);
                    } else if (event == "keyUp") {
                        let jsonPayload = jsonObj["payload"];
                        let settings = jsonPayload["settings"];
                        let coordinates = jsonPayload["coordinates"];
                        let userDesiredState = jsonPayload["userDesiredState"];
                        KrabsTime.onKeyUp(context, settings, coordinates, userDesiredState);
                    } else if (event == "willAppear") {
                        //let jsonPayload = jsonObj["payload"];
                        let settings = jsonPayload["settings"];
                        let coordinates = jsonPayload["coordinates"];
                        let userDesiredState = jsonPayload["userDesiredState"];
                        KrabsTime.onWillAppear(context, settings, coordinates, userDesiredState);
                    } else if (event == "willDisappear") {
                        var settings = jsonPayload['settings'];
                        var coordinates = jsonPayload['coordinates'];
                        KrabsTime.onWillDisappear(context, settings, coordinates);
                    } else if (event == "sendToPlugin") {
                        console.log("sendToPlugin received payload: ", jsonPayload);
                    } else if (event == "didReceiveSettings") {
                        console.log("didReceiveSettings received payload: ", jsonPayload);
                        let settings = jsonPayload["settings"];
                        let coordinates = jsonPayload["coordinates"];
                        let userDesiredState = jsonPayload["userDesiredState"];
                        KrabsTime.onWillAppear(context, settings, coordinates, userDesiredState);
                        }

                  };
                  websocket.onclose = function () {};
              };

        </script>
    </body>
</html>
